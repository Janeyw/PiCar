

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Software &mdash; PiCar Project 2018 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Datasheet" href="datasheet.html" />
    <link rel="prev" title="Electronics" href="electronics.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> PiCar Project
          

          
          </a>

          
            
            
              <div class="version">
                2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials.html">Tutorials</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../usage.html">Usage</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="mechanical.html">Mechanical</a></li>
<li class="toctree-l2"><a class="reference internal" href="electronics.html">Electronics</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Software</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#socket-file-transfer">Socket File Transfer</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#basic-file-transfer">Basic File Transfer</a></li>
<li class="toctree-l4"><a class="reference internal" href="#advanced-folder-transfer">Advanced Folder Transfer</a></li>
<li class="toctree-l4"><a class="reference internal" href="#wi-fi-router-settings">Wi-Fi Router Settings</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#sensors-lidar-imu">Sensors (Lidar, IMU)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#setup">Setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#code">Code</a></li>
<li class="toctree-l4"><a class="reference internal" href="#steps">Steps</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#camera-data-by-rapid-capturing">Camera data by rapid capturing</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#connection">Connection</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id1">Code</a></li>
<li class="toctree-l4"><a class="reference internal" href="#resources">Resources</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#sensors-camera-concurrent-reading-using-timers">Sensors &amp; Camera concurrent reading using Timers</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id2">Connection</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">Code</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">Resources</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#data-logging">Data Logging</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#version-alpha-camera-data-imu-data-lidar-data">Version Alpha (Camera data, IMU data, LiDar Data)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">Code</a></li>
<li class="toctree-l4"><a class="reference internal" href="#version-beta-magnetic-reading-added-to-imu">Version Beta (Magnetic reading added to IMU)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#version-beta-2-0-code-re-organization-process-self-contained-pmu-reading">Version Beta 2.0 (Code re-organization, Process, self contained, PMU reading)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#data-analysis">Data Analysis</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#data-and-photo-synchronization">Data and photo synchronization</a></li>
<li class="toctree-l4"><a class="reference internal" href="#display-synchronized-data-and-photo">Display Synchronized Data and Photo</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="datasheet.html">Datasheet</a></li>
<li class="toctree-l2"><a class="reference internal" href="picar_usage.html">The Picar Module</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../results.html">Results</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelogs.html">Changelogs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributors.html">Contributors</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">PiCar Project</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../usage.html">Usage</a> &raquo;</li>
        
      <li>Software</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/chapters/usage/software.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="software">
<h1>Software<a class="headerlink" href="#software" title="Permalink to this headline">¶</a></h1>
<p>The software section will document all the heavy duty programming
programming aspects of the project. There may be some overlap with
the Electronics section.</p>
<div class="section" id="socket-file-transfer">
<h2>Socket File Transfer<a class="headerlink" href="#socket-file-transfer" title="Permalink to this headline">¶</a></h2>
<div class="section" id="basic-file-transfer">
<h3>Basic File Transfer<a class="headerlink" href="#basic-file-transfer" title="Permalink to this headline">¶</a></h3>
<div class="section" id="server-side">
<h4>Server side<a class="headerlink" href="#server-side" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">socket</span>                   <span class="c1"># Import socket module</span>

<span class="n">port</span> <span class="o">=</span> <span class="mi">60000</span>                    <span class="c1"># Reserve a port for your service.</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>             <span class="c1"># Create a socket object</span>
<span class="n">host</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyaddr</span><span class="p">(</span><span class="s2">&quot;your IP static IP if under same Wi-Fi&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>     <span class="c1"># Get local machine name</span>
<span class="n">s</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>            <span class="c1"># Bind to the port</span>
<span class="n">s</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>                     <span class="c1"># Now wait for client connection.</span>

<span class="k">print</span> <span class="p">(</span><span class="s1">&#39;Server listening....&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">))</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>     <span class="c1"># Establish connection with client.</span>
    <span class="k">print</span> <span class="p">(</span><span class="s1">&#39;Got connection from&#39;</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Server received&#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

    <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;your file name&#39;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">l</span><span class="p">):</span>
       <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
       <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Sent &#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">l</span><span class="p">))</span>
       <span class="n">l</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>          <span class="c1">#alter this to control data sending rate</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Done sending&#39;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="client-side">
<h4>Client side<a class="headerlink" href="#client-side" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">socket</span>                   <span class="c1"># Import socket module</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>             <span class="c1"># Create a socket object</span>
<span class="n">host</span> <span class="o">=</span> <span class="s1">&#39;your ip address&#39;</span>     <span class="c1"># Get local machine name</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">60000</span>                    <span class="c1"># Reserve a port for your service.</span>

<span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
<span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;Hello server!&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">))</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;received_file&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">print</span> <span class="p">(</span><span class="s1">&#39;file opened&#39;</span><span class="p">)</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;receiving data...&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>          <span class="c1">#must be identical to the data rate at server side</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;data=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="c1"># write data to a file</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Successfully get the file&#39;</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;connection closed&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="advanced-folder-transfer">
<h3>Advanced Folder Transfer<a class="headerlink" href="#advanced-folder-transfer" title="Permalink to this headline">¶</a></h3>
<p><em>Creator: Jerry Kong</em></p>
<p>To meet our need of a neat and organized data structure, this script is created.
It has the capability to transfer the entire folder to another remote desktop,
no matter whether it is on a Windows System or Unix system.
The script rests in <code class="docutils literal notranslate"><span class="pre">PiCar/src/Logging</span></code>
To use the script, first set-up the IP addresses like in the basic version,
change the root variable to the root folder name.
Place the script at the same level as the root folder. Start the server script
and then start the client script. The folder would then be transferred.
A better protocol could be implemented, since the protocol being used now
is not really efficient.</p>
</div>
<div class="section" id="wi-fi-router-settings">
<h3>Wi-Fi Router Settings<a class="headerlink" href="#wi-fi-router-settings" title="Permalink to this headline">¶</a></h3>
<p><em>Creator: Jerry Kong</em></p>
<p><em>This section is dedicated to users who are not familiar with Wi-Fi network
setting, TCP protocol and wireless connection</em></p>
<p>To establish communication between two machine we need to know their IP address.
Moreover, to provide a consistent network experience, a machine would
have many ports to receive connections of different forms, with other devices.
Thus we also need to agree on the port that two machines establish the
connection on. However, depending on different internet environment and
different ways of connection (Wi-Fi or ethernet), the IP address would also vary.
With this section, you would get a sense of how this complicated system works
and hopefully learn how to cope with “Connection fails” error when you are
using the script.</p>
<div class="section" id="ip-address">
<h4>IP Address<a class="headerlink" href="#ip-address" title="Permalink to this headline">¶</a></h4>
<p>IP’s full name is Internet Protocol. It’s a scheme that specifies how computers
find each other in the pool of Internet. The rules behind it is complicated,
but the most important thing is that it serves as an identification
for modern devices connected to Internet.</p>
</div>
<div class="section" id="ipv4-vs-ipv6">
<h4>IPv4 vs IPv6<a class="headerlink" href="#ipv4-vs-ipv6" title="Permalink to this headline">¶</a></h4>
<p>As a protocal, IP would have different versions, the latest version is version
6 and thus called IPv6. While IPv6 is stronger and has a larger pool of
Internet, the older version IPv4 is not obsolete.
The logic behind the two protocals are the same, hence we would now stick with
IPv4, since it has a more concise format. (XXX.XX.XX.XXX)</p>
</div>
<div class="section" id="wi-fi-vs-ethernet">
<h4>Wi-Fi vs Ethernet<a class="headerlink" href="#wi-fi-vs-ethernet" title="Permalink to this headline">¶</a></h4>
<p>Wi-Fi is more convenient while wired connection (ethernet) offer steadiness and
low latency. However, it is important to note that a computer connected to
Wi-Fi does not have an IP, or at least, an acknowledged IP.
The Wi-Fi or the router serves as a broadcaster and spread the connection from
the ethernet to multiple machines, but they have the same IP address. The
router can identify each machine by the IP address it assigns to the machine,
but the machine can’t use that address as the identification on the internet.
Conclusively, machines under the same Wi-Fi build up a small intranet where
these machines can identify each other by the address they are assigned,
but once outside Wi-Fi network they are no longer acknowledged.</p>
<p>See
<a class="reference external" href="https://www.raspberrypi.org/forums/viewtopic.php?t=191140">Setup static IP address for RaspberryPi</a>
, so a machine would be assigned the same IP address when connected to the Wi-Fi.</p>
</div>
<div class="section" id="tcp">
<h4>TCP<a class="headerlink" href="#tcp" title="Permalink to this headline">¶</a></h4>
<p>TCP, Transmission Control Protocol, is a higher level protocol that enables
data sending via the connection established by IP. Socket, a method based on
TCP is typical method used for data transfer.</p>
</div>
<div class="section" id="port-forwarding">
<h4>Port Forwarding<a class="headerlink" href="#port-forwarding" title="Permalink to this headline">¶</a></h4>
<p>With the knowledge about address in mind we could start the connection once we
have the right port. It is easy to do so if both machines are on Internet or
under the same Wi-Fi, since they can identify with each other. Just pick up an
empty port and they are good to go.
However, we do want to establish connection between two machines even if one is
on Wi-Fi and the other is on Internet. To do so, we use port forwarding. With
port forwarding, a client can find the address of the router and use the port
that is forwarded to connect with the machine.</p>
<p>For example, the address of the router is <code class="docutils literal notranslate"><span class="pre">172.10.10.111</span></code>, and a machine
under the Wi-Fi is assigned static IP <code class="docutils literal notranslate"><span class="pre">192.168.1.188</span></code>. The routher and the
machine agree on that the connection to the port <code class="docutils literal notranslate"><span class="pre">30000</span></code> of the routher would
be forwarded to the port <code class="docutils literal notranslate"><span class="pre">6000</span></code> of the machine and vice versa.
Thus a laptop could setup a connection with <code class="docutils literal notranslate"><span class="pre">172.10.10.111</span></code> on port <code class="docutils literal notranslate"><span class="pre">30000</span></code>
to connect the port 6000 on machine with static IP <code class="docutils literal notranslate"><span class="pre">192.168.1.188</span></code>.</p>
<p>See
<a class="reference external" href="https://www.howtogeek.com/66214/how-to-forward-ports-on-your-router/">How to setup port forwarding</a></p>
</div>
</div>
</div>
<div class="section" id="sensors-lidar-imu">
<h2>Sensors (Lidar, IMU)<a class="headerlink" href="#sensors-lidar-imu" title="Permalink to this headline">¶</a></h2>
<div class="section" id="setup">
<h3>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h3>
<p>Make sure you have alreadly connected TFmini Lidar and IMU as
<a class="reference external" href="/usage/electronics.html#pi-and-tfmini-lidar-communication">TFmini Lidar</a>
, <a class="reference external" href="/usage/electronics.html#pi-and-imu-communication">IMU by LSM9DS1</a> did,
and download the corresponding libraries.</p>
</div>
<div class="section" id="code">
<h3>Code<a class="headerlink" href="#code" title="Permalink to this headline">¶</a></h3>
<p>Under sub-directory <code class="docutils literal notranslate"><span class="pre">PiCar/src/pi/IMU_Lidar</span></code></p>
</div>
<div class="section" id="steps">
<h3>Steps<a class="headerlink" href="#steps" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li>Download the repository and connect sensors correctly</li>
<li>Run the python script <code class="docutils literal notranslate"><span class="pre">Lidar_IMU_read_optimize.py</span></code></li>
</ol>
<p>3. After the program ends, you should see two csv files under the same
directory. One records the time between two consecutive reads, and the other
one contains data from sensors in the format:
<code class="docutils literal notranslate"><span class="pre">timestamp,</span> <span class="pre">distance,</span> <span class="pre">accelaration</span> <span class="pre">in</span> <span class="pre">x,y,z,</span> <span class="pre">angular</span> <span class="pre">velocity</span> <span class="pre">in</span> <span class="pre">x,y,z</span></code></p>
</div>
</div>
<div class="section" id="camera-data-by-rapid-capturing">
<h2>Camera data by rapid capturing<a class="headerlink" href="#camera-data-by-rapid-capturing" title="Permalink to this headline">¶</a></h2>
<div class="section" id="connection">
<h3>Connection<a class="headerlink" href="#connection" title="Permalink to this headline">¶</a></h3>
<p>Connect the camera correctly as mentioned in <a class="reference external" href="https://projects.raspberrypi.org/en/projects/getting-started-with-picamera">Getting started with
picamera</a></p>
</div>
<div class="section" id="id1">
<h3>Code<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">picamera</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="n">frames</span> <span class="o">=</span> <span class="mi">20</span>

<span class="k">def</span> <span class="nf">filenames</span><span class="p">():</span>
    <span class="n">frame</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">frame</span> <span class="o">&lt;</span> <span class="n">frames</span><span class="p">:</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">yield</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.jpg&#39;</span> <span class="o">%</span> <span class="n">current</span>
        <span class="n">frame</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="k">with</span> <span class="n">picamera</span><span class="o">.</span><span class="n">PiCamera</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="p">(</span><span class="mi">480</span><span class="p">,</span><span class="mi">480</span><span class="p">),</span> <span class="n">framerate</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span> <span class="k">as</span> <span class="n">camera</span><span class="p">:</span>
    <span class="n">camera</span><span class="o">.</span><span class="n">start_preview</span><span class="p">()</span>
    <span class="c1"># Give the camera some warm-up time</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">camera</span><span class="o">.</span><span class="n">capture_sequence</span><span class="p">(</span><span class="n">filenames</span><span class="p">(),</span> <span class="n">use_video_port</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">finish</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Captured </span><span class="si">%d</span><span class="s1"> frames at </span><span class="si">%.2f</span><span class="s1">fps, in </span><span class="si">%f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span>
    <span class="n">frames</span><span class="p">,</span>
    <span class="n">frames</span> <span class="o">/</span> <span class="p">(</span><span class="n">finish</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span> <span class="p">(</span><span class="n">finish</span> <span class="o">-</span> <span class="n">start</span><span class="p">)))</span>
</pre></div>
</td></tr></table></div>
<p>This will give you real time and fps.</p>
</div>
<div class="section" id="resources">
<h3>Resources<a class="headerlink" href="#resources" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><a class="reference external" href="https://picamera.readthedocs.io/en/release-1.13/">PiCamera Module</a></li>
<li><a class="reference external" href="https://picamera.readthedocs.io/en/release-1.13/recipes2.html#rapid-capture-and-processing">Rapid capture and processing</a></li>
</ul>
</div>
</div>
<div class="section" id="sensors-camera-concurrent-reading-using-timers">
<h2>Sensors &amp; Camera concurrent reading using Timers<a class="headerlink" href="#sensors-camera-concurrent-reading-using-timers" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id2">
<h3>Connection<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>Connect the IMU, TFmini Lidar, and PiCamera as before.</p>
</div>
<div class="section" id="id3">
<h3>Code<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>The code for this part is under directory <code class="docutils literal notranslate"><span class="pre">PiCar/src/pi/pythonTimer</span></code></p>
</div>
<div class="section" id="id4">
<h3>Resources<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><a class="reference external" href="https://docs.python.org/3.4/library/multiprocessing.html?highlight=process">Python multiprocessing–Process-based Parallelism</a></li>
<li><a class="reference external" href="https://docs.python.org/3/library/threading.html#timer-objects">Python threading timer object</a></li>
</ul>
</div>
</div>
<div class="section" id="data-logging">
<h2>Data Logging<a class="headerlink" href="#data-logging" title="Permalink to this headline">¶</a></h2>
<div class="section" id="version-alpha-camera-data-imu-data-lidar-data">
<h3>Version Alpha (Camera data, IMU data, LiDar Data)<a class="headerlink" href="#version-alpha-camera-data-imu-data-lidar-data" title="Permalink to this headline">¶</a></h3>
<p><em>Creator : Jerry Kong</em></p>
<p>Ensure to correctly connect all electronics.</p>
</div>
<div class="section" id="id5">
<h3>Code<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>The code could be found in`` PiCar/src/pi/IMU_Lidar``, you can find the method
to enable IMU library <a class="reference external" href="http://picar.readthedocs.io/en/latest/chapters/usage/electronics.html#pi-and-imu-communication">here</a></p>
<p><strong>IMPORTANT: If you have gone through the process before 06/18/2018, make
sure you execute all steps again, few more functions and wrappers are added to
the library</strong></p>
<p>Run the script, a folder under the same directory would be generated, its
name would be the starting timestamp of the script.</p>
<p>The file itself contains several straight forward methods that can be used to
get data from IMU LiDar. The method it uses to take pictures is currently only
viable within the script.</p>
<p>The IMU setting functions can’t be used outside the script.</p>
<p>If called from command line or python shell, the script would place the image
capturing and data logging proceses into two different cores on RaspberryPi</p>
<p>Use the command line option, you can bring up the usage page</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python Lidar_IMU_data_optimize_delta.py -h
</pre></div>
</div>
<p>The script is based on delta timing (<a class="reference external" href="https://docs.python.org/2.4/lib/timer-objects.html">timers</a>)
method. A constant value of 0.0007 is subtracted from the period to maintain a
consistent reading frequency.</p>
<p>Precision defines the minimum time that the script goes to check the diffrence
between the last time and current time and consequently defines within what
time difference that measures of LiDar and IMU occur simultaneously.</p>
<p><strong>A great part of the codes are from Josh Jin’s sensor/camera reading code</strong></p>
</div>
<div class="section" id="version-beta-magnetic-reading-added-to-imu">
<h3>Version Beta (Magnetic reading added to IMU)<a class="headerlink" href="#version-beta-magnetic-reading-added-to-imu" title="Permalink to this headline">¶</a></h3>
<p><em>Creator : Jerry Kong</em></p>
<p><em>The code could be found in PiCar/src/pi/IMU_Lidar, the socket_server_client.py file is a integrated and important part of this data logging script, to learn more about socket folder sending, take a look at</em> ` socket based file sending &lt;<a class="reference external" href="http://picar.readthedocs.io/en/latest/chapters/usage/software.html#advanced-folder-transfer">http://picar.readthedocs.io/en/latest/chapters/usage/software.html#advanced-folder-transfer</a>&gt;`_</p>
<p>Endless mode is implemented. User could stop the experiment with KeyboardInterrupt, the logging file and camera file would still be saved</p>
<p>Using -i command line input, we could run the script in endless mode (i.e. the duration would be set to 1000 seconds, we could stop the program by using KeyboardInterrupt(Ctrl + C))</p>
<p>Logging file sending module is integarted into the logging script. After the multiprocessing finished (loggind and filming), the script would start a raw socket server and a client on another computer could use the client side script to receive the logging file.</p>
<p>The script could either be called from the terminal or from other script by calling the funtion getSensorAndCamera.</p>
<p>‘-s’ command line argument and save parameter for getSensorAndCamera is implemented so that users can decide whether they want the logging file to be saved locally.</p>
<p>For installation and usage see the previous section</p>
</div>
<div class="section" id="version-beta-2-0-code-re-organization-process-self-contained-pmu-reading">
<h3>Version Beta 2.0 (Code re-organization, Process, self contained, PMU reading)<a class="headerlink" href="#version-beta-2-0-code-re-organization-process-self-contained-pmu-reading" title="Permalink to this headline">¶</a></h3>
<p><em>Creator : Jerry Kong</em></p>
<p><em>The code could be found in PiCar/src/pi/IMU_Lidar, device_int is the main file</em></p>
<p>The code is factor out and classified in an interface-oriented manner(i.e. the objects are put into class by its interface)</p>
<p>The class structure is:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>device
<span class="p">|</span>-----camera
<span class="p">|</span>-----sensor
        <span class="p">|</span>-----pmucounter
        <span class="p">|</span>-----IMU
        <span class="p">|</span>-----LiDar
</pre></div>
</div>
<p>Instead of its different class structure, the parameter for the main function is also different</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">getSensorAndCamera</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;192.168.1.121&#39;</span><span class="p">,</span><span class="n">port</span><span class="o">=</span><span class="mi">6000</span><span class="p">,</span><span class="n">save</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">duration</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">endless</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">trAccRate</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span><span class="n">trGyroRate</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
                     <span class="n">trMagRate</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span><span class="n">accScale</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">gyroScale</span><span class="o">=</span><span class="mi">245</span><span class="p">,</span><span class="n">magScale</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">cameraFreq</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">imuRate</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">lidarRate</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">precision</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">tm</span><span class="o">=</span><span class="p">[])</span>
</pre></div>
</div>
<p>Currently, to stop the sending process, a remote desktop must reach to the Server</p>
<p>To pass a new device outside the file to the function, see the sample code below</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">device_int</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span>

<span class="k">class</span> <span class="nc">currentSensor</span><span class="p">(</span><span class="n">device_int</span><span class="o">.</span><span class="n">sensor</span><span class="p">):</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;CS&quot;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;currentSensor&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__conn</span> <span class="o">=</span> <span class="n">currentSensorCommunicationPort</span>

  <span class="k">def</span> <span class="nf">detect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__conn</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">getFieldSize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    return a int</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mi">1</span>

  <span class="k">def</span> <span class="nf">getHeader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    return a list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;current&quot;</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">getValue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    return the sensor reading</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__conn</span><span class="o">.</span><span class="n">getCurrent</span><span class="p">()]</span>

 <span class="n">cs</span> <span class="o">=</span> <span class="n">currentSensor</span><span class="p">()</span>

 <span class="n">currentTimer</span> <span class="o">=</span> <span class="n">device_int</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">currentSensor_read_period</span><span class="p">)</span>

 <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="n">device_int</span><span class="o">.</span><span class="n">getSensorAndCamera</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">,</span><span class="n">save</span><span class="p">,</span><span class="n">duration</span><span class="p">,</span><span class="n">endless</span><span class="p">,</span><span class="n">trAccRate</span><span class="p">,</span><span class="n">trGyroRate</span><span class="p">,</span>
                      <span class="n">trMagRate</span><span class="p">,</span><span class="n">accScale</span><span class="p">,</span><span class="n">gyroScale</span><span class="p">,</span><span class="n">magScale</span><span class="p">,</span><span class="n">cameraFreq</span><span class="p">,</span><span class="n">imuRate</span><span class="p">,</span><span class="n">lidarRate</span><span class="p">,</span><span class="n">precision</span><span class="p">,[</span><span class="n">currentTimer</span><span class="p">]))</span>

 <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
 <span class="c1">#do some operation</span>
 <span class="n">p</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="data-analysis">
<h2>Data Analysis<a class="headerlink" href="#data-analysis" title="Permalink to this headline">¶</a></h2>
<p><em>Creator: Feiyang Jin</em></p>
<div class="section" id="data-and-photo-synchronization">
<h3>Data and photo synchronization<a class="headerlink" href="#data-and-photo-synchronization" title="Permalink to this headline">¶</a></h3>
<p>Once we get all data/photo from one experiment and save somewhere, we would like to synchronize them.</p>
<p>As camera speed is much slower than sensors speed, the sychronization is not perfect.</p>
<p><strong>Algorithm: first match each photo to a row of data based on timestamp(best fit), then for unmatched data, find its previous closed photo and take it.</strong></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This algorithm is a work in progress. If you have better strategy, please contact me.</p>
</div>
<p>The code is called <code class="docutils literal notranslate"><span class="pre">sync_time.py</span></code> under <code class="docutils literal notranslate"><span class="pre">PiCar/src/dataAnalysis</span></code>, and all raw data/photo are under <code class="docutils literal notranslate"><span class="pre">data_photo</span></code> under same directory.</p>
<p><strong>Result: The python programe will output a csv file in the same directory, the format is [data1][data2]……[matched_photo]</strong></p>
</div>
<div class="section" id="display-synchronized-data-and-photo">
<h3>Display Synchronized Data and Photo<a class="headerlink" href="#display-synchronized-data-and-photo" title="Permalink to this headline">¶</a></h3>
<p>The sychronized csv file provides us unlimited possibility. The following image shows the display site we built.</p>
<a class="reference internal image-reference" href="../../_images/data_display_site.png"><img alt="../../_images/data_display_site.png" src="../../_images/data_display_site.png" style="width: 700px; height: 300px;" /></a>
<p>Source for this website is under <code class="docutils literal notranslate"><span class="pre">PiCar/src/dataAnalysis/Display</span></code>, the html requires you to upload the sychronized csv file, and then give you all the magic.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You will need to install chart.js first; for papaParse.js, I include the package for you.</p>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="datasheet.html" class="btn btn-neutral float-right" title="Datasheet" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="electronics.html" class="btn btn-neutral" title="Electronics" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, xz-group.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'2018',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>